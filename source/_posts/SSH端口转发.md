---
title: SSH 端口转发
date: 2021-04-20
tags: 
    - Linux
    - SSH
    - 远程连接
---

## 一、基本连接

```bash
ssh username@hostname
```

1. 执行命令、运行 SSH 客户端的主机，称为本地主机 Host A
2. 接收连接请求、运行 SSH 服务器的主机，称为远程主机 Host B

`username`是主机 B 上已登录的用户名， `hostname` 则是主机 B 的设备名、域名或 IP 等可以在网络（局域网或互联网）上定位的名称。

<!-- more -->

## 二、本地端口转发

本地端口转发是将应用【application client】对于本地主机 A 指定端口 X 的访问请求转发给主机 B，交由主机 B 对另一指定主机 C 的指定端口 Z 发起访问。命令如下：

```bash
ssh -L 主机A**端口X**:**主机C**:主机C**端口Z** username@hostname
# 简单理解为：将对A:X的访问转变成对C:Z的访问
```

- 客户端在执行端口转发命令的同时，实际上也执行了基本的连接命令。
- `-L`  表示使用「本地端口转发」选项，之后是用冒号分隔开的三个需要指定的项。
- 原理上，主机C可以是任何能够被主机B识别到的设备，也可以是主机B自身。

当主机C在其某端口提供某服务【application server】，主机A需要使用该服务却无法直接访问主机 C 或该端口时，如果发现有 SSH：A→B 的连接，且主机B能够直接访问主机C的该端口，本地端口转发就派上用场。

![SSH%20%E7%AB%AF%E5%8F%A3%E8%BD%AC%E5%8F%91%20f634a3d5d7854a5eb11df6c10df00b8c/Untitled.png](https://i.loli.net/2021/05/16/uyIt1MnveJX3RSr.png)

## 三、远程端口转发

当主机 C 在其某端口提供某服务，主机B需要使用该服务却无法直接访问主机 C 或该端口时，如果发现有 SSH：A→B 的连接，且主机A能够直接访问主机 C 的该端口，远程端口转发就派上用场。

![SSH%20%E7%AB%AF%E5%8F%A3%E8%BD%AC%E5%8F%91%20f634a3d5d7854a5eb11df6c10df00b8c/Untitled%201.png](https://i.loli.net/2021/05/16/8ZuJz2Ca9oNpxBS.png)

此时访问请求在主机 B 一侧发生，而 SSH 连接的方向却没有变化，仍是由 A 到 B 的。

与本地端口转发的流动方向相反，远程端口转发是将对于远程主机 B 指定端口 Y 的访问请求转发给主机 A ，交由主机 A 对另一指定主机 C 的指定端口 Z 发起访问。命令如下：

```bash
ssh -R 主机B**端口Y**:**主机C**:**主机C端口Z** username@hostname
# 简单理解为：将对B:Y的访问转变成对C:Z的访问
```

- username@hostname不变，因为我们仍然以从主机 A 对主机 B 发起 SSH 连接为基础；
- `-R` 旗标表示使用「远程端口转发」选项，之后是用冒号分隔开的三个需要指定的项。
- 原理上，主机 C 可以是任何能够被主机 A 识别到的设备，也可以是主机 A 自身。

## 四、动态端口转发

动态端口转发可以把本地主机 A 上运行的 SSH 客户端转变成一个 SOCKS 代理服务器；

实际上它是一种特殊的本地端口转发，或者说叫它「动态本地端口转发」更科学。

这个动态，就动在这种转发不规定目标地址（主机C）和目标端口（端口Z），而是去读取应用发起的请求，从请求中获取目标信息。

```bash
ssh -D 主机A端口X username@hostname
```

## 五、端口转发的停止

SSH端口转发完全基于基本的SSH连接，因此，通过在远程终端上执行exit命令、暴力关闭本地终端窗口、远程主机B关机、本地主机A关机等可以切断SSH连接的方式，即可停止SSH端口转发。